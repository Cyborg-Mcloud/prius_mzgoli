<!DOCTYPE html>
<html>
<meta http-equiv="Content-Security-Policy"
      content="img-src * 'self' data:; default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://maps.googleapis.com; font-src 'self'  https://fonts.googleapis.com;">
	  
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <head>

  	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Prius Taxi Driver</title>

	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>

	<script type="text/javascript" charset="utf-8" src="io.js"></script>
	<script type="text/javascript" charset="utf-8" src="func.js"></script>
	<script type="text/javascript" charset="utf-8" src="maps.js"></script>

<script type="text/javascript" charset="utf-8">

var myaudio = new Audio('call.mp3');
myaudio.loop = true;
var myid = 0;
var mymap;

var nogps = 0;
document.addEventListener("deviceready", onDeviceReady, false);
var mystatus=0;
var myid=0;

var last_lat=41.7089554;
var last_long=44.7689831;


var wlon=44.7689831;
var wlat=41.7089554;
var MyUser="nouser";
var MyPass="nopass";
var MyZoom=17;

var MyLat=41.7089554;
var MyLong=44.7689831;
var MyAlt;
var MyHead;
var MySpeed;
var MyAcc;
var started;
started=0;

function onBackKeyDown() 
	{
	if (curwindow==1)
		{
		show_map();
		}
	}

function onMenuDown() 
	{
	if (curwindow==0)
		{
		show_settings();
		}
	}


function onSearchDown() 
	{
	if (myself==0)
		{
		setme();
		}
	}


var dataex=0;

var xtile;
var ytile;

var mousex;
var mousey;
var omousex;
var omousey;
	
var sx;
var sy;

var canacX;
var canacY;
var inter='none';

var inpause=0;

sx=getscreenw();
sy=getscreenh();
var myself=0;


var gamehttp;
if (window.XMLHttpRequest) {gamehttp=new XMLHttpRequest();}
else if (window.ActiveXObject) {gamehttp=new ActiveXObject('Microsoft.XMLHTTP');}
else {alert('Your browser does not support XMLHTTP!');}
gamehttp.onreadystatechange=update_data;


var userids = new Array();
var usernames = new Array();
var userlongs = new Array();
var userlats = new Array();
var useralts = new Array();
var userspeeds = new Array();
var userheads = new Array();
var userlasts = new Array();


var cache_ignore=0;
var cache_ignore_wifi=1;


var cur_down_i=0;
var cur_down_ii=0;
var down_complete=1;
var check_complete=1;
var file_downing=0;
var LT_finished=0;

   var watchID = null;
   var watchID2 = null;
var mrot=0;


var userebic=0;

var wehavecall=0;
var calllat=0;
var calllong=0;
var callid=0;
var txt_addr="";
var ertxelmainc=0;
var comp=0;
// powermanagement -ის ფუნქციები
//window.powermanagement.acquire();
//window.powermanagement.release();

// --------------------------------------------------------------------
function onDeviceReady() 
	{
	console.log("setting immersive");
	AndroidFullScreen.immersiveMode(successFunction, errorFunction);

// Custom full screen mode
// See https://developer.android.com/reference/android/view/View.html#setSystemUiVisibility(int)
//	AndroidFullScreen.setSystemUiVisibility(AndroidFullScreen.SYSTEM_UI_FLAG_FULLSCREEN, successFunction, errorFunction);


	console.log("device ready, checking connection");
	checkConnection();

	req_loc_acc();
	req_loc_auth();

	document.addEventListener("pause", onPause, false);
	//document.addEventListener("backbutton", onBackKeyDown, false);
	//document.addEventListener("menubutton", onMenuDown, false);
	//document.addEventListener("searchbutton", onSearchDown, false);
//	document.addEventListener("volumedownbutton", onVolumeDown, false);
//	document.addEventListener("volumeupbutton", onVolumeUp, false);


	window.addEventListener('orientationchange', doOnOrientationChange);
	console.log("device ready, getting position");
	navigator.geolocation.getCurrentPosition(onSuccess, onError, {enableHighAccuracy: true,  maximumAge:0});
	var opts = { timeout: 3000, enableHighAccuracy: true, maximumAge:0};
	watchID = navigator.geolocation.watchPosition(onSuccess, onError, opts);
	document.addEventListener("resume", onResume, false);
	window.addEventListener("deviceorientation", handleOrientation, true);

	 navigator.compass.getCurrentHeading(onCompassSuccess, function (compassError) { alert('Compass error: ' + compassError.code); })
	var moptions = { frequency: 500 };
	watchID2 = navigator.compass.watchHeading(onCompassSuccess, onError, moptions);
	
	console.log("device ready, dealing with record file");
	
	kc=checkIfFileExists("locdata.txt");
	if (started==0)	
		{
		Start();
		}
	//setmypos();
	}
// ------------------------

function onCompassSuccess(heading) 
	{  
	console.log(heading);
	comp=parseInt(heading.magneticHeading*100)/100;
	//document.getElementById("heading_div").innerHTML=parseInt(heading.magneticHeading);
	rotate_marker(comp);
    }


function MainProg()
	{
	//console.log("main prog");
	if (started==1)
		{	
		UpData();
	//	console.log("up data");
		if (callid>0 && inpause==0 && myself==2)
			{
			console.log("setting to call");
			setmypos();
			DrawUsers();
			}
		else if (myself==1 && inpause==0)
			{
	//		console.log("myself=1 and inpause=0, setting wlongebi");
			
			setmypos();

			}
			

		navigator.geolocation.getCurrentPosition(onSuccess, onError, {enableHighAccuracy: true,  maximumAge:0});
		setTimeout("MainProg();",1000);
	
		}
	}

var call_dest_lat=0;
var call_dest_long=0;
var call_dest_addr="";
var sit_price=3;
var kmprice=0.75;

var call_tel="";
var call_meters=0;
function update_data()
	{		
	if(gamehttp.readyState == 4)
		{
		mr=gamehttp.responseText;
		if (mr!="")
			{
			console.log("-- data received from server: "+mr);
			if (mr=="register")		
				{
				//alert("Please Register Your User at\n\r http://taxiprius.com.ge/");
			//	started=0;
			//	document.getElementById('mainb').innerHTML="START";
				Start();
				//alert("please REGISTER at website: www.developer.design.ge/mytaxi");
				}
			else
				{
				a=mr.split("|");
				if (a[0]=="newcall")
					{
					document.getElementById("client_center").style.display="inline";
					b=a[1].split(";");
					curid=b[0];
					if (callid!=curid && myself==0)
						{
					//	setme();
						}
					callid=curid;
					calllat=parseFloat(b[1]);
					calllong=parseFloat(b[2]);	
					txt_addr=b[3];

					call_meters=0;
					call_tel=b[4];
					call_dest_lat=parseFloat(b[6]);
					call_dest_long=parseFloat(b[7]);
					call_dest_addr=b[8];
					draw_markers();
					set_status(101);
					ertxelmainc=1;
					if (call_dest_lat>30)
						{
						var startpos = {lat: calllat, lng: calllong};
						var endpos = {lat: call_dest_lat, lng: call_dest_long};
						calcRoute(startpos, endpos, dirService, dirRender);

						myself=0;
						}
					}
				else if (a[0]=="yourcall")
					{
					callconfirming=0;
					document.getElementById("client_center").style.display="inline";
					b=a[1].split(";");
					curid=b[0];
					callid=curid;
					calllat=parseFloat(b[1]);
					calllong=parseFloat(b[2]);	
					txt_addr=b[3];
					c=b[4];
					call_meters=b[5];
					call_tel=b[4];
					console.log("call_tel: " +call_tel);
					call_dest_lat=parseFloat(b[6]);
					call_dest_long=parseFloat(b[7]);
					call_dest_addr=b[8];


					ertxelmainc=1;
					if (call_dest_lat>30)
						{
						var startpos = {lat: calllat, lng: calllong};
						var endpos = {lat: call_dest_lat, lng: call_dest_long};
						//calcRoute(startpos, endpos, dirService, dirRender);
						}
					if (callid!=curid && myself==0)
						{
						setme();
						}
					draw_markers();
					set_status(1);
					}
				else if (a[0]=="waiting")
					{
					callconfirming=0;
					document.getElementById("client_center").style.display="inline";
					b=a[1].split(";");
					curid=b[0];
					if (callid!=curid && myself==0)
						{
					//	setme();
						}
					callid=curid;
					calllat=parseFloat(b[1]);
					calllong=parseFloat(b[2]);	
					txt_addr=b[3];
					call_tel=b[4];
					call_meters=b[5];
					call_dest_lat=parseFloat(b[6]);
					call_dest_long=parseFloat(b[7]);
				//	call_dest_addr=b[8];
				
					ertxelmainc=1;
					if (call_dest_lat>30)
						{
						var startpos = {lat: calllat, lng: calllong};
						var endpos = {lat: call_dest_lat, lng: call_dest_long};
						//calcRoute(startpos, endpos, dirService, dirRender);
						}
					draw_markers();
					set_status(3);
					}
				else if (a[0]=="usercoming")
					{
					callconfirming=0;
					document.getElementById("client_center").style.display="inline";
					b=a[1].split(";");
					curid=b[0];
					if (callid!=curid && myself==0)
						{
					//	setme();
						}
					callid=curid;
					calllat=parseFloat(b[1]);
					calllong=parseFloat(b[2]);
					txt_addr=b[3];
					call_tel=b[4];
					call_meters=b[5];

					call_dest_lat=parseFloat(b[6]);
					call_dest_long=parseFloat(b[7]);
					//call_dest_addr=b[8];
					
					ertxelmainc=1;
					if (call_dest_lat>30)
						{
						var startpos = {lat: calllat, lng: calllong};
						var endpos = {lat: call_dest_lat, lng: call_dest_long};
					//	calcRoute(startpos, endpos, dirService, dirRender);
						}
					draw_markers();
					set_status(4);
					}
				else if (a[0]=="moving")
					{
						callconfirming=0;
					document.getElementById("client_center").style.display="none";

					b=a[1].split(";");
					curid=b[0];

					callid=curid;
					calllat=parseFloat(b[1]);
					calllong=parseFloat(b[2]);	
					txt_addr=b[3];
					call_meters=b[5];
					call_tel=b[4];
					document.getElementById("meters_txt").innerHTML=parseInt(10*call_meters/1000)/10+" კმ";
					document.getElementById("price_txt").innerHTML=(sit_price+parseInt((call_meters/1000)*kmprice*100)/100 ) +" ლარი";
					call_dest_lat=parseFloat(b[6]);
					call_dest_long=parseFloat(b[7]);
				//	call_dest_addr=b[8];
					
					ertxelmainc=1;
					if (call_dest_lat>30)
						{
						var startpos = {lat: calllat, lng: calllong};
						var endpos = {lat: call_dest_lat, lng: call_dest_long};
						//calcRoute(startpos, endpos, dirService, dirRender);
						}
					if (callid!=curid && myself==0) {setme();}
					draw_markers();
					set_status(5);
					}
				else
					{
					callconfirming=0;
					document.getElementById("client_center").style.display="none";
					if (curdisp!=0)	{set_status(0);}
					txt_addr="";
					calllong=0;
					calllat=0;
					callid=0;
					call_tel="";
					call_meters=0;

					call_dest_lat=0;
					call_dest_long=0;
					call_dest_addr="";
					startMarker.setMap(null);
					endMarker.setMap(null);
					dirRender.setMap(null);
					}
				if (inpause==0)	{DrawUsers();}

				if (userebic==1)
					{
					

					a=mr.split("|");
					for (i=0;i<(a.length-1);i++ )
						{
						if (a[i]!="")
							{
							
							b=a[i].split(";");
							
							var curid=b[0];

							if ( document.getElementById("user_"+curid)==null)
								{
								document.getElementById("users").innerHTML+="<div id='user_"+curid+"'  style='position:absolute; left:0px; top:0px; color:red; font-size:12px; font-weight:bold;'><div style='position:absolute; left:-16px; top:-16px; width:32px; height:32px;'><img src='taxizm.png'></div></div>"; //&nbsp;&nbsp;"+b[1]+"
								}
							userids[i]=curid;
							usernames[i]=b[1];
							userlats[i]=parseFloat(b[2]);
							userlongs[i]=parseFloat(b[3]);
							useralts[i]=parseFloat(b[4]);
							userspeeds[i]=parseFloat(b[5]);
							userheads[i]=parseFloat(b[6]);
							userlasts[i]=parseInt(b[7]);
							}
						}
					var tdata=a[a.length-1];

					if (inpause==0)	{DrawUsers();}
					}

				}
			}
		}
	}

function UpData()
	{

	if (MyUser!="nouser")
		{    
		url="http://taxiprius.com.ge/taxi.php?uname="+MyUser+"&pass="+MyPass+"&lat="+MyLat+"&long="+MyLong+"&alt="+MyAlt+"&head="+MyHead+"&speed="+MySpeed+"&passive="+inpause+"&mstat="+mystatus+"&callid="+callid;		
		}
	else
		{
		url="http://taxiprius.com.ge/taxi.php?passive="+inpause;
		}
	console.log("-- upload: "+url);
//	document.getElementById('erorebi').innerHTML="uname="+MyUser+"&pass="+MyPass+"&lat="+MyLat+"&long="+MyLong+"&alt="+MyAlt+"&head="+MyHead+"&speed="+MySpeed;
	gamehttp.open('GET',url,true);
	gamehttp.send(null);
	
	
	}

function Start()
	{
	console.log("Start / END");
	if (started==0)
		{
			started=1;  MainProg();}  // document.getElementById('mainb').innerHTML="STOP";
	//else
//		{started=0;} //  document.getElementById('mainb').innerHTML="START";/

	}

var pauza_chartulia=0;

function onPause()
	{
	console.log("on pause");
//	if (started==0) 
		//{
	if (pauza_chartulia==1)
		{
		//started=0;
		clearWatch();
		inpause=1;
	WriteData();
		}
	//}

	
	}

function onResume() 
	{
	console.log("on resume");
	if (inpause==1)
		{
		inpause=0;
		}

	if (started==0)
		{
		checkConnection();
	
	var opts = { timeout: 3000, enableHighAccuracy: true, maximumAge:0};
	watchID = navigator.geolocation.watchPosition(onWatchSuccess, onError, opts);
	
		if (MyUser!="nouser")	{Start();}
		}

	//checkIfFileExists("locdata.txt");
	//if (dataex==0)
	//	{WriteData();}	

	//ReadData();
	//setmypos();
	//DrawUsers();
	}


function onSuccess(position) 
	{
	console.log(position);
	var gaitvaliscine=0;
	if (gaitvaliscine==1)
		{
		
		var element = document.getElementById('geopos');
		element.innerHTML = 'Latitude: '           + position.coords.latitude              + '<br />' +
								'Longitude: '          + position.coords.longitude             + '<br />';

		MyLat=position.coords.latitude ;
		MyLong=position.coords.longitude ;
		MyAlt=position.coords.altitude ;
		MyHead=position.coords.heading ;
		MySpeed=position.coords.speed ;
		MyAcc=position.coords.accuracy;

			if (MyHead!=null && MyHead>0)
			{
			rotate_marker(MyHead);
			}
		else
			{
			MyHead=calc_bearing(last_lat, last_long, MyLat, MyLong);
			rotate_marker(MyHead);
			}

		//wlon=MyLong;
		//wlat=MyLat;
		console.log("on succ, sett long");

		var latlng = new google.maps.LatLng(MyLat, MyLong);
		positionMarker.setPosition(latlng);

		if (started==0 && MyUser!="nouser")	{Start();}
		if (myself==1 && inpause==0)
			{
			setmypos();	
			}
		else if (inpause==0)	
			{

			}
		}
    }






 
function getpos()
	{
	console.log("get pos");
	document.getElementById('geopos').innerHTML="Finding geolocation...";
	navigator.geolocation.getCurrentPosition(onSuccess, onError);
	}


function onWatchSuccess(position) 
	{
	console.log("on watch success");

	MyLat=position.coords.latitude ;
	MyLong=position.coords.longitude ;
	MyAlt=position.coords.altitude ;
	MyHead=position.coords.heading ;
	MySpeed=position.coords.speed ;
	MyAcc=position.coords.accuracy  ;
	if (MyHead!=null && MyHead>0)
		{
		rotate_marker(MyHead);
		}
	else
		{
		MyHead=calc_bearing(last_lat, last_long, MyLat, MyLong);
		rotate_marker(MyHead);
		}

	if (inpause==0)
		{
		var element = document.getElementById('geopos');
		element.innerHTML = 'Latitude: '           + position.coords.latitude              + '<br />' +
							'Longitude: '          + position.coords.longitude             + '<br />';
		setmypos();		
		}
	}



function draw_markers()
	{
	var myLatLng = {lat: calllat, lng: calllong};
    startMarker.setPosition(myLatLng);
	startMarker.setMap(mymap);

	if (call_dest_lat>0)
		{
		var myLatLng = {lat: call_dest_lat, lng: call_dest_long};
		endMarker.setPosition(myLatLng);
		endMarker.setMap(mymap);
		}
	}

function doOnOrientationChange()
	{

	
	document.getElementById("fanjara").style.width="100%";
	document.getElementById("fanjara").style.height="100%";

	
	document.getElementById("charcho").style.width="100%";
	document.getElementById("charcho").style.height="100%";

	//alert(window.orientation);
	}
    </script>
  </head>
  <style>
	body {color:white; margin:0px; padding:0px;}
	a {text-decoration:none; color:white;}
  </style>
  <body bgcolor=black>
  				
		<!--<div style='width:256px; height:256px; position:relative; position:absolute; left:0px; top:0px; z-index:99;' >
			<img   id='myimg' style='width:256px; height:256px;'>
			<div style='position:absolute; left:0px; top:0px; background-color:red; width:7px; height:7px;' id='persona'></div>
		</div>-->
<!--  width:400px; height:600px;-->
<div id='fanjara' style='position:fixed; left:0px; top:0px; overflow:hidden; width:100%; height:100%; z-index:1;'>
		
<!--<div  style='position:fixed; left:0px; top:0px; width:100%; height:50px; background-color:white; z-index:211; ' >
	<div style='float:left; z-index:212;'><img src='but_info.png'></div>
	<div id='infodiv' style='float:right; width:250px; color:Black; z-index:212;'></div>
</div>-->
		<!-- MAIN MAP width:365px; height:600px;  -->
<div id='charcho' style='position:absolute; left:1px; top:1px; width:100%; height:100%;z-index:1;' >
		<div id='mainw' style='position:absolute; left:0px; top:0px; height:100%; width:100%; z-index:2;' >
			

			  <div id="gmap"  style='position:absolute; left:0px; top:0px; height:100%; width:100%; display:block;'></div>
		</div>
		 <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAFY47FE__z9AvRLBoYG0T2XeOTiHdwzOQ&callback=initMap&language=ka&libraries=places"></script>
</div>
	

			
<a href='Javascript: setme();' style='position:fixed; bottom:110px; left:5px; margin:5px; z-index:252; ' ><img id='cbut' src='center.svg' style='width:50px; height:50px;'></a>

<a href='Javascript: set_client();' style='position:fixed; bottom:50px; left:5px; margin:5px; z-index:252; '  id='client_center' style='display:none;'><img id='client_but' src='client_icon.png'></a> <!--visibility:hidden-->
<a href='Javascript: show_settings();' style='position:fixed; top:45px; right:5px; margin:5px; z-index:252; ' ><img src='settings.png'></a> 



  <div style='position:fixed; left:0px; top:0px; display:none; z-index:1000; height:20%; width:100%; color:red; font-weight:Bold; background:white;'
       id='nogps'>
    <Br><Br><Br>
    <Center>ვერ ხერხდება GPS ლოკაცის მიღება</center>
  </div>


  <div style='position:fixed; left:0px; top:0px; display:none; z-index:1001; height:20%; width:100%; color:red; font-weight:Bold; background:white;'
       id='myint'>
    <Br><Br><Br>
    <Center>ჩართეთ ინტერნეტ კავშირი</center>
  </div>

<div id="bottom_menu" style='width:100%; position:fixed; top:0px; padding-top:10px; left:0px; height:120px; padding-left:20px; z-index:251; background-color:#3f3f3f; filter: alpha(opacity=90);	-moz-opacity: 0.5; -khtml-opacity: 0.5;  opacity: 0.5; width:100%; text-align:left;'>
		<Br>
		<div style=' text-align:left; font-size:26px; font-weight:Bold; ' id='qucha_txt'></div>

			<div id='no_call_screen' style='display:inline;'>
				<center>
				<a href='Javascript: status_change(0);' id='stat_but' style='border:1px solid gray; padding:5px; display:block; background-color:white; color:black; width:250px; font-size:24px;'>თავისუფალი ვარ</a>
				</center>
			</div>

			<div id='new_call_screen' style=' width:100%; display:none; position:absolute; left:0px; top:230px; text-align:center; '>
				<center><a href='Javascript: call_confirm();' id='call_confirm' style='border:1px solid gray; padding:5px; display:block; background-color:green; color:white; padding:10px; font-size:28px; width:250px; text-align:center; '>გამოძახების მიღება</a></center>
			</div>

			<div id='my_call_screen' style=' width:100%; display:none;'>

				<a href='Javascript: iArrived();' id='arrived_but' style=' border:1px solid gray; padding:5px; display:block; background-color:green; color:white; width:200px; font-size:16px; -moz-opacity: 1; -khtml-opacity: 1;  opacity: 1; '>მოვედი</a>
				
				
			</div>

			<div id='user_wait_screen' style=' width:100%; display:none;'>
				
				
				<a href='Javascript: user_met();' id='arrived_but' style=' border:1px solid gray; padding:5px; display:block; background-color:green; color:white; width:200px; font-size:16px; -moz-opacity: 1; -khtml-opacity: 1;  opacity: 1; '>ჩავისვი</a>
				
				
			</div>

			<div id='user_pay_screen' style='position:fixed; bottom:0px; left:0px; height:130px;background-color:white; width:100%; display:none; color:black;'>
			<Br>

				<table width=100%>
				<tr><td align=center>
				<a href='Javascript: userpay(1);' id='arrived_but' style=' border:1px solid gray; padding:5px; display:block; background-color:green; color:white; font-size:24px;'>დასრულება</a>
				
				<!--&nbsp; &nbsp; &nbsp;
				<a href='Javascript: userpay(2);' id='arrived_but' style='float:right; border:1px solid gray; padding:5px; display:block; background-color:blue; color:white; width:70px; font-size:16px;'>ბარათი</a>-->
				</td>
				</tr>
				<Tr><td style=' font-size:24px;' align=center>
				მანძილი: <span name='meters_txt' id='meters_txt' style=' font-size:24px;'></span> თანხა: <span style=' font-size:24px;'  name='price_txt' id='price_txt'></span> <!--<input type='number' id='mytanxa' size=4 style=' font-size:16px;'>-->
				</td></tr>
</table>
				

			</div>

		</div>

	</div>

	   			<!--<table width=100% cellpadding=0 cellspacing=0>
			<tr><Td align=left><a href='Javascript:zoomme(1);' style='float:left; font-size:30px; margin:5px;'><img src='zoomin.png'></a></td>
			<td align=center><a href='Javascript: setme();' style='margin:5px; ' ><img id='cbut' src='centeroff.png'></a></td>
			<Td align=center><a href='Javascript: show_settings();' style='margin:5px;'><img src='settings.png'></a></td>
			<td align=right><a href='Javascript:zoomme(-1);' style='float:right; margin:5px;   '><img src='zoomout.png'></a></td>
			</table>-->




	<div id='settings_sheet' style='visibility:hidden; position:absolute; left:0px; top:0px; padding:10px; z-index:10000000;'>
		<br>
		<div id='mydiv'></div>
		<br>
		<p id="geopos">Finding geolocation...</p>

	<b>Map Type</b><br>
	<select id='maptype' onChange='changemap();'>
	<option value='1' >Open Street Map (fast)</option>
	<option value='2'>Open Cycle Map (slow)</option>
	<option value='3' selected>Google Sattelite (fast)</option>
	<option value='4'>Google Hybrid (fast)</option>
	<option value='5'>Google Terrain (fast)</option>
	<option value='6'>Google BLACK Strange 1 (very fast)</option>
	<option value='7'>Google BLACK Strange 2 (fast)</option>
	<option value='8'>Wiki MAP (slow)</option>
	<option value='9'>Watercolor Map (very slow)</option>
	<option value='10'>Toner MAP (slow)</option>
	</select>
		<Br><Br>
		<a href='Javascript: show_map();' style='color:blue;'>Back</a>
<br>
ეკრანის ორიენტაცია: <a href='Javascript: setori(1);'>ვერტიკალური</a> / <a href='Javascript: setori(2);'>ჰორიზონტალური</a>
	<br><br>
		<div id='erorebi'>Tilebi (zoom:16)</div>
		<b>Profile Details</b>
		<table>
			<tr><td>User:</td><td> <input type='text' id='myname' name='myname' value='youuser' size=12></td></tr>
			<tr><td>Pass:</td><td> <input type='password' id='mypass' name='mypass' value='yourpass' size=6></td>
			<td rowspan=2><a style='' href='Javascript: saveuser();'><img src='save.png'></a></td></tr>
		</table>
		<br><br>
		<input type='checkbox' id='ignor_cache' name='ignor_cache' onchange='cignore();'> Ignore Cache<br>
		<input type='checkbox' id='ignor_cache_on_wifi' name='ignor_cache_on_wifi' onchange='cignorewifi();' checked> Ignore Cache on WiFi<br>
	</div>
<script>

function setori(ori)
{
//
//if (ori==1)
//	{
//	var so = cordova.plugins.screenorientation;
//     so.setOrientation(so.Orientation.PORTRAIT);
//	}
//else
//	{
//	var so = cordova.plugins.screenorientation;
//     so.setOrientation(so.Orientation.LANDSCAPE);
//	}

}

function userpay(pmethod)
{
	if (callid>0)
		{
		//tanxa=document.getElementById("mytanxa").value;
		//document.getElementById("mytanxa").value="";
		tanxa=1+parseInt((call_meters/1000)*0.75*100)/100;
		url="http://taxiprius.com.ge/pay.php?uname="+MyUser+"&pass="+MyPass+"&id="+callid+"&pmethod="+pmethod+"&amount="+tanxa;
			
		console.log("usermet upload: "+url);
		gamehttp.open('GET',url,true);
		gamehttp.send(null);
		document.getElementById("client_center").style.display="none";
		callid=0;
		mystatus=0;
		calllat=0;
		calllong=0;
		call_tel="";
		call_meters=0;
		call_dest_lat=0;
		call_dest_long=0;
		call_dest_addr="";
		set_status(0);
		}
}


function user_met()
{
	if (callid>0)
		{
		url="http://taxiprius.com.ge/usermet.php?uname="+MyUser+"&pass="+MyPass+"&id="+callid;
			
		console.log("usermet upload: "+url);
		gamehttp.open('GET',url,true);
		gamehttp.send(null);
		}
}
function iArrived()
	{

	if (callid>0)
		{
		url="http://taxiprius.com.ge/arrived.php?uname="+MyUser+"&pass="+MyPass+"&id="+callid;
			
		console.log("arrived upload: "+url);
		gamehttp.open('GET',url,true);
		gamehttp.send(null);
		}
	}
var callconfirming=0;
function call_confirm()
	{
	if (callid>0)
		{
		callconfirming=1;
		url="http://taxiprius.com.ge/confirm.php?uname="+MyUser+"&pass="+MyPass+"&id="+callid;
			
		console.log("upload: "+url);
		gamehttp.open('GET',url,true);
		gamehttp.send(null);
		}
	}

function status_change(newstat)
	{
	console.log("cur status: "+mystatus);
	if (mystatus==0 && newstat==0)
		{mystatus=2;
		document.getElementById("stat_but").innerHTML="დაკავებული ვარ";
		document.getElementById("stat_but").style.backgroundColor="red";
		document.getElementById("stat_but").style.color="white";
		}
	else if (mystatus==2 && newstat==0)
		{mystatus=0;
		document.getElementById("stat_but").innerHTML="თავისუფალი ვარ";
		document.getElementById("stat_but").style.backgroundColor="white";
		document.getElementById("stat_but").style.color="green";
		}
	
	console.log("new status: "+mystatus);
	}

var curdisp=0;

function set_status(newstat)
	{
	console.log("status change: "+newstat+ " / "+curdisp);
	if (newstat==0 && curdisp!=0)
		{
		if (ertxelmainc==1)
			{	
			document.getElementById("bottom_menu").style.height='90px';
			document.getElementById("bottom_menu").style.opacity = "0.9";
			document.getElementById("bottom_menu").style.filter  = 'alpha(opacity=90)';
			
			document.getElementById("no_call_screen").style.display="inline";
			document.getElementById("new_call_screen").style.display="none";
			document.getElementById("my_call_screen").style.display="none";
			document.getElementById("user_wait_screen").style.display="none";
			document.getElementById("user_pay_screen").style.display="none";
			document.getElementById("qucha_txt").innerHTML="";
			myaudio.pause();
			myaudio.currentTime = 0;
			mystatus=0;
			curdisp=0;
			}
		}
	else if (newstat==101 && curdisp!=101)
		{
		curdisp=101;
		document.getElementById("bottom_menu").style.height='100%';
		document.getElementById("bottom_menu").style.opacity = "0.4";
			document.getElementById("bottom_menu").style.filter  = 'alpha(opacity=40)';
			
		document.getElementById("no_call_screen").style.display="none";
		document.getElementById("new_call_screen").style.display="inline";
		document.getElementById("my_call_screen").style.display="none";
		document.getElementById("user_wait_screen").style.display="none";
		document.getElementById("user_pay_screen").style.display="none";
		document.getElementById("qucha_txt").innerHTML=txt_addr+"<BR>მიმართულება: "+call_dest_addr+"<BR>"+call_tel;
		console.log("1: "+txt_addr+"<BR>მიმართულება:"+call_dest_addr+"<BR>"+call_tel);
		myaudio.play();
		mystatus=0;
		// shemosulia axali shekveta, irekeba zari
		}
	else if (newstat==1 && curdisp!=1)
		{
		document.getElementById("bottom_menu").style.height='180px';
		document.getElementById("bottom_menu").style.opacity = "0.9";
		document.getElementById("bottom_menu").style.filter  = 'alpha(opacity=90)';
			
		myaudio.pause();
		myaudio.currentTime = 0;
		curdisp=1;
		document.getElementById("no_call_screen").style.display="none";
		document.getElementById("new_call_screen").style.display="none";
		document.getElementById("my_call_screen").style.display="inline";
		document.getElementById("user_wait_screen").style.display="none";
		document.getElementById("user_pay_screen").style.display="none";
		document.getElementById("qucha_txt").innerHTML=txt_addr+"<BR>მიმართულება: "+call_dest_addr+"<BR>"+call_tel;
				console.log("2: "+txt_addr+"<BR>მიმართულება:"+call_dest_addr+"<BR>"+call_tel);
		mystatus=1;
		// shekveta migebulia
		}
	else if (newstat==3 && curdisp!=3)
		{
		myaudio.pause();
		myaudio.currentTime = 0;
		curdisp=3;
		document.getElementById("bottom_menu").style.height='180px';
		document.getElementById("bottom_menu").style.opacity = "0.9";
		document.getElementById("bottom_menu").style.filter  = 'alpha(opacity=90)';
			
		document.getElementById("no_call_screen").style.display="none";
		document.getElementById("new_call_screen").style.display="none";
		document.getElementById("my_call_screen").style.display="none";
		document.getElementById("user_wait_screen").style.display="none";
		document.getElementById("user_pay_screen").style.display="none";
		document.getElementById("qucha_txt").innerHTML=txt_addr+"<BR>მიმართულება: "+call_dest_addr+"<BR>"+call_tel;
				console.log("3: "+txt_addr+"<BR>მიმართულება:"+call_dest_addr+"<BR>"+call_tel);
		mystatus=3;
		}
	else if (newstat==4 && curdisp!=4)
		{
		myaudio.pause();
		myaudio.currentTime = 0;
		curdisp=4;
		document.getElementById("bottom_menu").style.height='180px';
		document.getElementById("bottom_menu").style.opacity = "0.9";
		document.getElementById("bottom_menu").style.filter  = 'alpha(opacity=90)';
			
		document.getElementById("no_call_screen").style.display="none";
		document.getElementById("new_call_screen").style.display="none";
		document.getElementById("my_call_screen").style.display="none";
		document.getElementById("user_wait_screen").style.display="inline";
		document.getElementById("user_pay_screen").style.display="none";
		document.getElementById("qucha_txt").innerHTML=txt_addr+"<BR>მიმართულება: "+call_dest_addr+"<BR>"+call_tel;
				console.log("4: "+txt_addr+"<BR>მიმართულება:"+call_dest_addr+"<BR>"+call_tel);
		mystatus=4;
		}
	else if (newstat==5 && curdisp!=5)
		{
		myaudio.pause();
		myaudio.currentTime = 0;
		curdisp=5;
		document.getElementById("bottom_menu").style.height='180px';
		document.getElementById("bottom_menu").style.opacity = "0.9";
		document.getElementById("bottom_menu").style.filter  = 'alpha(opacity=90)';
			
		document.getElementById("no_call_screen").style.display="none";
		document.getElementById("new_call_screen").style.display="none";
		document.getElementById("my_call_screen").style.display="none";
		document.getElementById("user_wait_screen").style.display="none";
		document.getElementById("user_pay_screen").style.display="inline";
		document.getElementById("qucha_txt").innerHTML=txt_addr+"<BR>მიმართულება: "+call_dest_addr;
				console.log("5: "+txt_addr+"<BR>მიმართულება:"+call_dest_addr+"<BR>"+call_tel);

		mystatus=5;
		// chavisvi, vmozraob
		}
		
	}

function cignore()
	{
	if (document.getElementById("ignor_cache").checked==true)
		{	cache_ignore=1;	}
	else
		{	cache_ignore=0;	}
	}

function cignorewifi()
	{
	if (document.getElementById("ignor_cache_on_wifi").checked==true)
		{	cache_ignore_wifi=1;	}
	else
		{	cache_ignore_wifi=0;	}
	}

function setme()
	{
	console.log("setme");

	if(myself!=1)
		{myself=1; document.getElementById("cbut").src='center_sel.svg';document.getElementById("client_but").src='client_icon.png';}
	else {myself=0;document.getElementById("cbut").src='center.svg';}

	}

	
function set_client()
	{
	console.log("setme");

	if(myself!=2)
		{myself=2; document.getElementById("client_but").src='client_center.png';document.getElementById("cbut").src='center.svg';}
	else {myself=0;document.getElementById("client_but").src='client_icon.png';}

	}

document.getElementById("maptype").value=1;
var curmap=1;

function changemap()
	{
		console.log("change map");
	curmap=document.getElementById("maptype").value;
	oxt=0;oyt=0;
	setmypos();
	}

var curwindow=0;

function show_settings()
	{

	checkConnection();

	curwindow=1;
	document.getElementById("fanjara").style.visibility="hidden";
	document.getElementById("settings_sheet").style.visibility="visible";
	}


function show_map()
	{
	curwindow=0;
	document.getElementById("fanjara").style.visibility="visible";
	document.getElementById("settings_sheet").style.visibility="hidden";
	}


function stopScrolling( touchEvent )
			{ touchEvent.preventDefault(); }


document.body.addEventListener( 'touchmove' , stopScrolling , false );
var mcl="orange";


function DrawUsers()
	{

		
	}


var but1=0;

var sfinx=0;
var finy=0;

function mup()
	{
		//console.log("mouse up");
	but1=0;
	sfinx=0; sfiny=0;
	check_user_click();
	//document.getElementById("mainb").innerHTML="Up";
	}




document.getElementById("fanjara").style.width=sx+"px";
document.getElementById("fanjara").style.height=sy+"px";



function saveuser()
	{

	MyUser=document.getElementById("myname").value;
	MyPass=document.getElementById("mypass").value;

	WriteData(); 
	alert("user saved: "+MyUser);
	if(started==0)
		{
		Start();
		}
	}


var curx;
var cury;

var oxt=0;
var oyt=0;
var tilef=0;

var kartX;
var kartY;

function setmypos()
	{
 
	 if (window.navigator.onLine == false) {
        document.getElementById("myint").style.display = "inline";
    }
    else {
        document.getElementById("myint").style.display = "none";
    }
	if (myself==1)
		{
		//mymap.setMyLocationEnabled(true);
		mymap.panTo(positionMarker.getPosition());
		}


 //   var myLatLng = {lat: MyLat, lng: MyLong};
   // positionMarker.setPosition(myLatLng);
   
    console.log("move main marker");
	}

function check_user_click()
	{
//	console.log("checking user click "+(omousex-canacX-kartX) + " and " + (omousey-canacY-kartY));
//	for (i=0;i<userids.length ;i++ )
//		{
//		curid=userids[i];
//
//		var x=long2pixel(userlongs[i], MyZoom);
//		var y=lat2pixel(userlats[i], MyZoom);
//	
//		var difx=Math.floor((x-xtile)*256);
//		var dify=Math.floor((y-ytile)*256);
//		difx=(256*(myw-1)/2)+difx-128;
//		dify=(256*(myh-1)/2)+dify-128;
//
//		if ( (difx-16)<(omousex-canacX-kartX) && (omousex-canacX-kartX)<(difx+16) &&  (dify-16)<(omousey-canacY-kartY) && //(omousey-canacY-kartY)<(dify+16) )
//			{
//			show_profile(i);
//			}
//		}
	}

function hide_profile()
	{
	document.getElementById("profile_div").style.visibility="hidden";

	curtaxi=-1;
	}
var curtaxi=-1;

function show_profile(tid)
	{
	var curtaxi=tid;
	document.getElementById("profile_div").style.visibility="visible";

	}




 function fail(error) 
	{
    console.log(error.code);
    }




function onError(e) 
	{
		return;
		console.log(e);
		nogps++;
		if (nogps > 1) {
			document.getElementById("nogps").style.display = "inline";
		}
	 
	}




function onRequestSuccess( success)
	{
    console.log("Successfully requested accuracy "+success.message);
	var k=success.message;
	var b=k.split("agreed");
	if (b.length>1)
		{
		// aplikaciis restarti tu motxovna gaxda sachiro da userma ok utxra
		location.reload();
		}
	
    }

function onRequestFailure(error)
	{
    console.log("Accuracy request failed: error code="+error.code+"; error message="+error.message);
	}

function req_loc_acc()
	{
	var accuracy = 3;
	var accuracyName  = "High Accuracy";
	console.log("requesting acc");
	cordova.plugins.locationAccuracy.request(onRequestSuccess, onRequestFailure, cordova.plugins.locationAccuracy.REQUEST_PRIORITY_HIGH_ACCURACY);
	}

function req_loc_auth()
	{
	console.log("requesting auth");
	cordova.plugins.diagnostic.isLocationAuthorized(function (authorized) {
		if(!authorized)
			{

			cordova.plugins.diagnostic.requestLocationAuthorization(function (status) {
				console.log("Requested location authorization: authorization was " + status);
				 
				}, onError, cordova.plugins.diagnostic.locationAuthorizationMode.ALWAYS);
			}
		else
			{
			onError("App is already authorized to use location");
			}
		}, onError);
	}


function open_loc_settings()
	{
	cordova.plugins.diagnostic.switchToLocationSettings();
	}

function successFunction()
{
    console.info("It worked!");
}

function errorFunction(error)
{
    console.error(error);
}

function trace(value)
{
    console.log(value);
}

function calc_bearing(lat1, long1, lat2, long2)
	{

	var y = Math.sin(long2-long1) * Math.cos(lat2);
	var x = Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(long2-long1);
	var brng = Math.atan2(y,x);
console.log("bearing calc: "+brng+" / "+(brng*360/6.28)+" = "+ ( (brng*360/6.28+360) % 360 ) + " x:"+x+" Y:"+y);
	return (brng*360/6.28+360) % 360;

	}

</script></body>
</html>
